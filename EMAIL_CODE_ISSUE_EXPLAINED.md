# Email Code Issue - Explained & Solution

## The Problem

You're seeing TWO different codes:
1. **Code in the alert/terminal** - Generated by our app
2. **Code in the email** - Generated by Supabase

They are DIFFERENT because Supabase's `signInWithOtp()` generates its own code and doesn't use the one we provide.

---

## Why This Happens

When we call:
```javascript
supabase.auth.signInWithOtp({
  email: email,
  options: {
    data: {
      code: "123456"  // Our code
    }
  }
})
```

Supabase:
1. Ignores our code
2. Generates its own 6-digit code
3. Sends that code in the email
4. Uses `{{ .Token }}` variable in the template

**Result:** Email has Supabase's code, not ours!

---

## Current Workaround (What We're Using Now)

**For now, use the code from the alert, not from the email.**

The alert shows:
```
‚úÖ Password Reset Code Sent!

‚ö†Ô∏è IMPORTANT: Use this code (not the one in email):

üîê YOUR CODE: 123456

Why? Supabase generates a different code in the email.
For now, use the code shown above.
```

This works because:
- Our code is stored in localStorage
- Our verification function checks against our code
- Email is just for show (for now)

---

## Proper Solutions

### Solution 1: Use Custom Email Service (RECOMMENDED for Production)

Instead of Supabase's built-in email, use a service like Resend or SendGrid:

#### Step 1: Sign up for Resend
1. Go to https://resend.com
2. Create free account
3. Get API key

#### Step 2: Install Resend in your project
```bash
npm install resend
```

#### Step 3: Create email sending function
```javascript
import { Resend } from 'resend';

const resend = new Resend('your-api-key');

export async function sendPasswordResetEmail(email: string, code: string) {
  await resend.emails.send({
    from: 'UBUTABERAhub <noreply@ubutaberahub.rw>',
    to: email,
    subject: 'Password Reset Code - UBUTABERAhub',
    html: `
      <h2>Password Reset Code</h2>
      <p>Your code is: <strong>${code}</strong></p>
    `
  });
}
```

#### Step 4: Use in password reset
```javascript
const code = generateCode();
await sendPasswordResetEmail(email, code);
// Now email has YOUR code!
```

**Pros:**
- ‚úÖ Full control over email content
- ‚úÖ Can include your exact code
- ‚úÖ Custom branding
- ‚úÖ Your domain (noreply@ubutaberahub.rw)

**Cons:**
- Requires additional service
- Costs money (after free tier)
- More setup

---

### Solution 2: Backend Function (Best for Production)

Create a backend function (Supabase Edge Function or separate API) that:
1. Generates code
2. Stores in database
3. Sends email with that exact code
4. Verifies against database

This is the most secure and professional approach.

---

### Solution 3: Accept Supabase's Code (Simplest)

Instead of generating our own code, use Supabase's code:

#### Update the flow:
1. Call `signInWithOtp()`
2. Supabase generates code
3. Supabase sends email
4. User enters code from email
5. Verify using `supabase.auth.verifyOtp()`

**Pros:**
- ‚úÖ Works with Supabase's system
- ‚úÖ No custom email service needed
- ‚úÖ Secure

**Cons:**
- ‚ùå Less control over email content
- ‚ùå Can't customize code format
- ‚ùå Tied to Supabase

---

## What to Do Right Now

### For Testing/Development:
**Use the code from the alert** (what we have now)
- Works immediately
- No additional setup
- Good for testing

### For Production:
**Implement Solution 1 (Custom Email Service)**
- Professional
- Full control
- Your branding
- Your domain

---

## Implementation Guide for Solution 1 (Resend)

### Step 1: Install Resend
```bash
npm install resend
```

### Step 2: Create email utility
Create `src/lib/email.ts`:

```typescript
import { Resend } from 'resend';

const resend = new Resend(import.meta.env.VITE_RESEND_API_KEY);

export async function sendPasswordResetCode(email: string, code: string) {
  try {
    await resend.emails.send({
      from: 'UBUTABERAhub <noreply@ubutaberahub.rw>',
      to: email,
      subject: 'Password Reset Code',
      html: `
        <div style="max-width: 600px; margin: 0 auto; font-family: Arial, sans-serif;">
          <div style="background: #000; padding: 30px; text-align: center;">
            <h1 style="color: #fff; margin: 0;">UBUTABERAhub</h1>
          </div>
          
          <div style="padding: 40px;">
            <h2>Password Reset Code</h2>
            <p>Your password reset code is:</p>
            
            <div style="background: #f9f9f9; border: 2px solid #000; border-radius: 8px; padding: 30px; text-align: center; margin: 30px 0;">
              <p style="font-size: 48px; font-weight: bold; letter-spacing: 8px; margin: 0;">${code}</p>
            </div>
            
            <p>This code expires in 10 minutes.</p>
            <p>If you didn't request this, ignore this email.</p>
          </div>
          
          <div style="background: #f9f9f9; padding: 20px; text-align: center;">
            <p>¬© 2024 UBUTABERAhub. All rights reserved.</p>
          </div>
        </div>
      `
    });
    
    return { success: true };
  } catch (error) {
    console.error('Email sending error:', error);
    return { success: false, error };
  }
}
```

### Step 3: Update auth.ts
```typescript
import { sendPasswordResetCode } from './email';

export async function requestPasswordReset(email: string) {
  const code = Math.floor(100000 + Math.random() * 900000).toString();
  
  // Store code
  localStorage.setItem('passwordResetData', JSON.stringify({
    email,
    code,
    timestamp: Date.now(),
    expiresIn: 10 * 60 * 1000,
  }));
  
  // Send email with OUR code
  await sendPasswordResetCode(email, code);
  
  return { code, error: null };
}
```

### Step 4: Add API key to .env.local
```
VITE_RESEND_API_KEY=re_your_api_key_here
```

Now the email will have YOUR code! üéâ

---

## Summary

**Current Status:**
- ‚úÖ Password reset works
- ‚ö†Ô∏è Must use code from alert (not email)
- ‚ö†Ô∏è Email code is different (Supabase limitation)

**For Production:**
- Use Resend or SendGrid
- Send emails with your own code
- Full control over branding
- Professional solution

**For Now:**
- Keep using alert code
- Works perfectly for testing
- Upgrade to custom email service when ready
